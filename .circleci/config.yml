version: 2.1

orbs:
  aws-cli: circleci/aws-cli@0.1.20
  aws-s3: circleci/aws-s3@2.0.0
  slack: circleci/slack@3.4.2

jobs:
  project-build:
    docker:
      - image: circleci/node:10.16.3-buster-browsers-legacy
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - run: npm i
      - run: npm run build
      - persist_to_workspace:
          root: DISTRIBUTION_FOLDER
          paths:
            - .
  project-deploy:
    docker:
      - image: 'cimg/python:3.6'
    steps:
      - attach_workspace:
          at: .
      - aws-s3/sync:
          arguments: |
            --delete
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-region: AWS_REGION
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          from: '.'
          to: "s3://${WEB_BUCKET_S3}-${ENV}/"
      - run: aws cloudfront create-invalidation --distribution-id ${CF_DISTRIBUTION_ID} --paths "/*"
workflows:
  build-deploy:
    jobs:
      - project-build
      - project-deploy:
          context: frontend-qa
          filters:
            branches:
              only: cicd
          requires:
            - project-build
      - project-deploy:
          context: frontend-stg
          filters:
            branches:
              only: cicd-stg
          requires:
            - project-build
      # - deploy-notification-stg:
      #     context: env-stage
      #     filters:
      #       branches:
      #         only: cicd-stg
      #     requires:
      #       - project-deploy-stg